name: CodeSandbox PR Preview

on:
  pull_request:
    types: [ opened, synchronize, reopened ]

permissions:
  pull-requests: write
  contents: read

jobs:
  add-preview-link:
    runs-on: ubuntu-latest

    steps:
      - name: Add CodeSandbox Preview Comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoName = context.repo.repo;
            const owner = context.repo.owner;
            const branch = context.payload.pull_request.head.ref;
            const sha = context.payload.pull_request.head.sha.substring(0, 7);

            const codesandboxUrl = `https://codesandbox.io/p/github/${owner}/${repoName}/${branch}`;

            const comment = `## üèñÔ∏è CodeSandbox Preview

            Preview this PR in an online IDE:

            [![Open in CodeSandbox](https://img.shields.io/badge/Open%20in-CodeSandbox-blue?style=for-the-badge&logo=codesandbox)](${codesandboxUrl})

            **Branch:** \`${branch}\`
            **Commit:** \`${sha}\`

            ---
            <sub>This preview updates automatically when you push new commits.</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: owner,
              repo: repoName,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üèñÔ∏è CodeSandbox Preview')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: owner,
                repo: repoName,
                comment_id: botComment.id,
                body: comment
              });
              console.log('‚úÖ Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: owner,
                repo: repoName,
                issue_number: prNumber,
                body: comment
              });
              console.log('‚úÖ Created new comment');
            }
